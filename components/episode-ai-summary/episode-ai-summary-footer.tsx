'use client';

import type { Tables } from '@/types/supabase/database';

import { createSupabaseBrowserClient } from '@/lib/services/supabase/browser';
import { Avatar, Flex, Text } from '@radix-ui/themes';
import { useEffect, useRef, useState } from 'react';
import { CgProfile } from 'react-icons/cg';
import { FaXTwitter } from 'react-icons/fa6';
import { TwitterShareButton } from 'react-share';

import styles from './episode-ai-summary-footer.module.css';

type Props = {
  id: Tables<'episode'>['id'];
};

const fetchData = async (id: Props['id']) => {
  const supabase = createSupabaseBrowserClient();

  const { data } = await supabase
    .from('episode_content')
    .select('id, user:account(id, name, avatar_url)')
    .eq('episode', id)
    .single();

  return data?.user ? { user: data.user } : { user: null };
};

export function EpisodeAISummaryFooter(props: Props) {
  const startedRef = useRef(false);
  const [data, setData] = useState<Awaited<
    ReturnType<typeof fetchData>
  > | null>(null);

  useEffect(() => {
    if (!startedRef.current) {
      startedRef.current = true;

      void fetchData(props.id)
        .then(setData)
        .catch(() => null);
    }
  }, [props.id]);

  if (data === null) {
    return null;
  }

  return (
    <Flex align="center" direction="row" justify="between" pr="1">
      {data.user ? (
        <Flex align="center" gap="1">
          <Avatar
            fallback={<CgProfile />}
            radius="full"
            size="1"
            src={data.user.avatar_url ?? ''}
          />

          <Text color="gray" size="1">
            Generated by <Text highContrast>{data.user.name}</Text>
          </Text>
        </Flex>
      ) : (
        <Text color="gray" size="1">
          Generated by a generous beecast user.
        </Text>
      )}

      <Flex>
        <TwitterShareButton
          title={`I've just used @beecast_ai to summarize a podcast episode and that was fast! Check it out: `}
          url={`${window.location.origin}/episode/${props.id}`}
        >
          <Flex align="center" className={styles.Share} gap="1">
            <Text size="1">Share on</Text>

            <Text className={styles.ShareIcon} size="1" trim="both">
              <FaXTwitter />
            </Text>
          </Flex>
        </TwitterShareButton>
      </Flex>
    </Flex>
  );
}
